<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOC - Explorer | {{ league_info.name }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="background-layer">
        <div class="grid-overlay"></div>
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="brand">
                <img src="{{ url_for('static', filename='logo_foc.png') }}" alt="FOC" class="brand-logo">
                <div class="brand-text">
                    <span class="brand-name">FOC</span>
                    <span class="brand-tagline">FIRST ON COTES</span>
                </div>
            </a>

            <div class="league-selector">
                {% for lid, linfo in all_leagues.items() %}
                <a href="/explore/{{ lid }}" class="league-link {% if lid == current_league %}active{% endif %}">
                    <span class="league-flag">{{ linfo.icon }}</span>
                    <span class="league-name">{{ linfo.name }}</span>
                </a>
                {% endfor %}
            </div>

            <div class="nav-tabs">
                <a href="/{{ current_league }}" class="nav-tab">MATCHS</a>
                <a href="/explore/{{ current_league }}" class="nav-tab active">EQUIPES</a>
                <a href="/graphics/{{ current_league }}" class="nav-tab">GRAPHIQUES</a>
                <a href="/my-bets" class="nav-tab">MES PARIS</a> 
            </div>

            <button class="refresh-btn" onclick="refreshData()">
                <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                <span class="refresh-text">ACTUALISER</span>
            </button>
        </div>
    </nav>

    <section class="hero compact">
        <div class="hero-content">
            <div class="hero-badge">
                <span class="badge-icon">{{ league_info.icon }}</span>
                <span class="badge-text">{{ league_info.country }}</span>
            </div>
            <h1 class="hero-title">Explorer par équipe</h1>
            <p class="hero-subtitle">Sélectionne une équipe pour afficher ses cotes</p>
        </div>
    </section>

    <section class="matches-section">
        <div class="section-container">
            <div class="filter-bar">
                <label class="filter-label" for="team-select">ÉQUIPE</label>
                <select id="team-select" class="filter-select">
                    <option value="">Choisir une équipe</option>
                    {% for team in teams %}
                    <option value="{{ team }}">{{ team }}</option>
                    {% endfor %}
                </select>
                <div class="filter-meta" id="team-count">0 match</div>
            </div>

            <div id="team-results" class="matches-list"></div>

            <div id="team-empty" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <line x1="9" y1="3" x2="9" y2="21"/>
                        <line x1="15" y1="3" x2="15" y2="21"/>
                        <line x1="3" y1="9" x2="21" y2="9"/>
                        <line x1="3" y1="15" x2="21" y2="15"/>
                    </svg>
                </div>
                <h3>Aucun match trouvé</h3>
                <p>Essaie une autre équipe</p>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="footer-content">
            <p>FOC - First On Cotes © 2024 · Données fournies par OddsPortal</p>
            <p class="footer-update">Dernière mise à jour : <span id="last-update"></span></p>
        </div>
    </footer>

    <script>
        const currentLeague = "{{ current_league }}";
        let isRefreshing = false;

        function updateLastUpdate() {
            const now = new Date();
            const timeElement = document.getElementById('last-update');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('fr-FR');
            }
        }
        updateLastUpdate();

        async function refreshData() {
            if (isRefreshing) {
                return;
            }
            const btn = document.querySelector('.refresh-btn');
            const text = btn.querySelector('.refresh-text');
            isRefreshing = true;
            btn.classList.add('loading');
            btn.disabled = true;
            text.textContent = 'SCRAPING...';

            try {
                const scrapeResponse = await fetch(`/api/refresh/${currentLeague}`);
                const scrapeData = await scrapeResponse.json();
                if (scrapeData.status !== 'success') {
                    throw new Error('Échec du scraping');
                }

                text.textContent = 'CHARGEMENT...';
                await new Promise(resolve => setTimeout(resolve, 8000));
                await refreshTeams();
                updateLastUpdate();

                text.textContent = 'SUCCÈS ✓';
                setTimeout(() => {
                    text.textContent = 'ACTUALISER';
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    isRefreshing = false;
                }, 1500);
            } catch (error) {
                text.textContent = 'ERREUR ✗';
                btn.classList.remove('loading');
                btn.disabled = false;
                setTimeout(() => {
                    text.textContent = 'ACTUALISER';
                    isRefreshing = false;
                }, 1500);
            }
        }

        async function refreshTeams() {
            const response = await fetch(`/api/teams/${currentLeague}`);
            const data = await response.json();
            if (data.status !== 'success') {
                return;
            }

            const select = document.getElementById('team-select');
            const current = select.value;
            select.innerHTML = '<option value="">Choisir une équipe</option>';
            data.teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                select.appendChild(option);
            });
            if (current) {
                select.value = current;
                await loadTeamMatches(current);
            }
        }

        async function loadTeamMatches(team) {
            const response = await fetch(`/api/team-matches/${currentLeague}?team=${encodeURIComponent(team)}`);
            const data = await response.json();
            if (data.status !== 'success') {
                return;
            }

            const results = document.getElementById('team-results');
            const empty = document.getElementById('team-empty');
            const count = document.getElementById('team-count');
            count.textContent = `${data.count} match${data.count > 1 ? 's' : ''}`;

            results.innerHTML = '';

            if (data.matches.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            data.matches.forEach((match, index) => {
                results.appendChild(createMatchCard(match, index));
            });
        }

        function createMatchCard(match, index) {
            const card = document.createElement('div');
            card.className = `match-card ${match.is_live ? 'live-card' : ''} visible`;
            card.style.animationDelay = `${index * 0.05}s`;

            let timeIndicator = '';
            if (match.is_live) {
                timeIndicator = `
                    <div class="match-live-indicator">
                        <span class="live-dot"></span>
                        <span class="live-time">${match.time}</span>
                    </div>
                `;
            } else {
                timeIndicator = `
                    <div class="match-time-badge">
                        <svg class="time-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span>${match.time}</span>
                    </div>
                `;
            }

            card.innerHTML = `
                ${timeIndicator}
                <div class="match-info">
                    <div class="match-teams">
                        <div class="team home">
                            <span class="team-name">${match.home_team}</span>
                            ${match.is_live ? `<span class="team-score">${match.score_home}</span>` : ''}
                        </div>
                        ${match.is_live ? '<div class="match-separator"></div>' : '<div class="match-vs">VS</div>'}
                        <div class="team away">
                            ${match.is_live ? `<span class="team-score">${match.score_away}</span>` : ''}
                            <span class="team-name">${match.away_team}</span>
                        </div>
                    </div>
                    <div class="match-odds">
                        <div class="odd-item" data-type="1">
                            <span class="odd-label">1</span>
                            <span class="odd-value">${match.odd_1}</span>
                        </div>
                        <div class="odd-item" data-type="x">
                            <span class="odd-label">X</span>
                            <span class="odd-value">${match.odd_x}</span>
                        </div>
                        <div class="odd-item" data-type="2">
                            <span class="odd-label">2</span>
                            <span class="odd-value">${match.odd_2}</span>
                        </div>
                    </div>
                </div>
                <div class="match-date">${match.date}</div>
            `;

            return card;
        }

        document.getElementById('team-select').addEventListener('change', async (event) => {
            const team = event.target.value;
            if (!team) {
                document.getElementById('team-results').innerHTML = '';
                document.getElementById('team-empty').style.display = 'none';
                document.getElementById('team-count').textContent = '0 match';
                return;
            }
            await loadTeamMatches(team);
        });
    </script>
</body>
</html>
